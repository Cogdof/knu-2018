<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="text/css" href="./index.css" />
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>

</style>
</head>
<body>
<!--백도어 들어갈 위치-->
<div style="position : fixed; top:0; left:0; height:100px; width:100%; background-color:#EEFFEE;">
    <input type="text" size="2" id="nextCardInput"/>
    <div id ="nextCards">

    </div>
</div>

<!-- Test Bet -->
<!--<div style="position : fixed; top:100px; left:0; height:100px; width:100%; background-color:#FFEEFF;">-->
    <!--<input type="text" id="betTestInput"/>  <button id="betTestButton">Test Bet</button>-->
<!--</div>-->

<!--랭킹들어갈 위치-->
<div style="position : fixed; top:100px; left:0; height:100px; width:100%; background-color:#FFEEFF;">
    <p id="ranking"></p>
</div>


<div style="height: 100px; width:100%">

</div>
<div>

    <div><span id="userId"></span></div>
    <div><span id="accountBalance"></span></div>

    <div class="buttons"><div class="btn" id="logout_button">logout</div></div>
</div>




<div class="page" id="login">
    <img src="blackjack.jpg", align="center">
    <div>
        <div class="buttons"><div class="btn" id="naver_login_button">Naver 로그인</div></div>
        <div class="buttons"><div class="btn" id="github_login_button">Github 로그인</div></div>
    </div>
</div>
<div class="page" id="lobby" style="display: none">
    <div>
        <div class="buttons"><div class="btn" id="create_room_button">Create</div></div>
    </div>
</div>
<div class="page" id="game" style="display: none">
    <div class="dealer-cards"></div>
    <div class="clear"></div>
    <div class="player-cards"></div>
    <div class="buttons"><div class="btn" id="hit">Hit</div><div class="btn" id="stand">Stand</div></div>
    <div class="buttons"><div class="btn" id="deal">Deal</div></div>
    <div class="buttons"><div class="btn" id="doubledown">Doubledown</div></div>
    <div class="buttons"><div class="btn" id="surrender">Surrender</div></div>

    <div class="betting-area">
        <div><b id="GameResult"></b></div>

        <b>Your Bet</b><br>
        <div id="bet" class="bet money">0</div>
        <div>
            <div class="btn" id="more">+</div>
            <div class="btn" id="less">-</div>
        </div>

        <div class="clear"></div>
    </div>
    <div>
        <b>Available Funds</b><br>
        <span id="money" class="money"></span>
        <div class="clear"></div>
    </div>
</div>
</body>
<script src="/blackjack/jquery-3.3.1.min.js"></script>

<script>
    var user;
    var gameRoomId;
    var gameRoomForConsoleLog;

    $.ajax({
        type: 'GET',
        url: '/api/users/myself',
        contentType:'application/json;'
    }).done(function(data) {
        if (data && data.name) {
            //console.log(data);

            $('#login').hide();
            $('#lobby').show();
            user = data;
            $("#userId").html(user.name);
            $("#accountBalance").html(user.account);

            getRanking();
        }
    });

    $('#naver_login_button').click(function() {
        location.href = '/login/naver'
    })

    $('#github_login_button').click(function() {
        location.href = '/login/github'
    })

    $('#logout_button').click(function() {
        location.href = '/logout'
    })

    $('#create_room_button').click(function() {
        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms',
        }).done(function(data) {

            $('#login').hide();
            $('#lobby').hide();
            $('#game').show();
            gameRoomId = data.roomId;
            drawGameRoom(data);

        });
    })


    $('#deal').click(function() {
        var bet = parseInt($('#bet').html());

        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms/' + gameRoomId + '/bet',
            data: JSON.stringify(bet),
            contentType:'application/json;',
        }).done(function(data) {
            if(data){
                drawGameRoom(data);
            }
        });
    })

     $('#betTestButton').click(function() {
        var testBet = parseInt($('#betTestInput').val());

        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms/' + gameRoomId + '/bet',
            data: JSON.stringify(testBet),
            contentType:'application/json;',
        }).done(function(data) {
            if(data){
                drawGameRoom(data);
            }
        });
    })

    $('#doubledown').click(function() {
        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms/' + gameRoomId + '/doubledown',
        }).done(function(data) {
            drawGameRoom(data);
        });
    })




    $('#nextCardInput').keypress(function(event){
        if(event.which!=13){
            return;
        }
        $.ajax({
            type: 'PUT',
            url: '/api/black-jack/rooms/' + gameRoomId + '/deck/cards',
            data: JSON.stringify(event.target.value),
            contentType:'application/json;',
        }).done(function(data) {
            drawGameRoom(data);
        });
    })


    $('#hit').click(function() {
        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms/' + gameRoomId + '/hit',
        }).done(function(data) {
            drawGameRoom(data);
        });
    })

    $('#stand').click(function() {
        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms/' + gameRoomId + '/stand',
        }).done(function(data) {
            drawGameRoom(data);
        });
    })


    $('#surrender').click(function() {
        $.ajax({
            type: 'POST',
            url: '/api/black-jack/rooms/' + gameRoomId + '/surrender',
        }).done(function(data) {
            drawGameRoom(data);
        });
    })


    $('#more').click(function(){
        var bet = 1000;
        var currentBet = parseInt($('#bet').html());

        if(currentBet>=10000)
            return;

        var money = parseInt($('#money').html());
        if (money < bet) {
            bet = money;
        }

        $('#bet').html(currentBet + bet);

        if(currentBet > 0 && money - bet <= 0) {
             $('#money').html(money - bet + ' [All IN]');
             alert('ALL IN');

        }

        else {
             $('#money').html(money - bet);
        }
    });

    $('#less').click(function(){
        var bet = 1000;
        var currentBet = parseInt($('#bet').html());
        var money = parseInt($('#money').html());
        if(currentBet < bet) {
            bet = currentBet;
        }

        $('#bet').html(currentBet - bet);
        $('#money').html(money + bet);
    });

    function drawGameRoom(gameRoom) {

        console.log(gameRoom);
        gameRoomForConsoleLog = gameRoom;


        if( (gameRoom.playerList[user.name].hand.cardList.length==2 && !gameRoom.finished)){
            $("#doubledown").css("visibility", "visible");
        } else {
            $("#doubledown").css("visibility", "hidden");
        }

        if (gameRoom.finished) {
            $('#deal').show();
            $('#more').show();
            $('#less').show();
            $('#hit').hide();
            $('#stand').hide();
            $('#surrender').hide();


            setTimeout(function() {
             switch(gameRoomForConsoleLog.playerList[user.name].gameStatus){
                case 0 :
                    alert('You Win');
                    break;
                case 1 :
                    alert('You Tie');
                    break;
                case 2 :
                    alert('You Lost');
                    break;
                 case 3 :
                    alert('You Surrender');
                    break;
            }}, 300)

        } else {

            $('#deal').hide();
            $('#more').hide();
            $('#less').hide();
            $('#hit').show();
            $('#stand').show();
            $('#surrender').show();

        }


        $('#nextCards').html("");
       gameRoom.deck.cardList.forEach(function(card) {
           $('#nextCards').append(card.rank+', ');
       });


        $('.dealer-cards').html("");
        gameRoom.dealer.hand.cardList.forEach(function(card) {
            $('.dealer-cards').append(generateCardDiv(card.rank, card.suit));
        })
        if (gameRoom.dealer.hand.cardList.length == 1) {
            $('.dealer-cards').append('<div class="card card2 flipped" data-value="6"></div>');
        }
        if (gameRoom.dealer.hand.cardList.length > 0) {
            $('.dealer-cards').append('<div id="dealerTotal" class="dealer-total">' + gameRoom.dealer.hand.cardSum + '</div>')
        }

        $('.player-cards').html("");
        gameRoom.playerList[user.name].hand.cardList.forEach(function(card) {
            $('.player-cards').append(generateCardDiv(card.rank, card.suit));
        });
        if (gameRoom.playerList[user.name].hand.cardList.length > 0) {
            $('.player-cards').append('<div id="playerTotal" class="player-total">' + gameRoom.playerList[user.name].hand.cardSum + '</div>')
        }




        var balance = gameRoom.playerList[user.name].balance;

        if(balance < parseInt($('#bet').html()) && gameRoom.finished ){
            $('#bet').html(gameRoom.playerList[user.name].balance);
        }

        if(gameRoom.finished){
            $('#money').html( (balance - parseInt($('#bet').html())));
        } else {
            $('#money').html( (balance));
        }

        if(parseInt($('#bet').html()) > 0 && balance - parseInt($('#bet').html()) == 0) {
             $('#money').html( (balance - parseInt($('#bet').html())) + '[All IN]');
             setTimeout(function() {
                alert('ALL IN');
             },500)
        }

        getRanking();
    }

    function generateCardDiv(rank, suit) {
        var className = "";
        switch (rank) {
            case 1 :
                className = "ace-of-";
                break;
            case 2:
                className = "two-of-";
                break;
            case 3 :
                className = "three-of-";
                break;
            case 4 :
                className = "four-of-";
                break;
            case 5 :
                className = "five-of-";
                break;
            case 6 :
                className = "six-of-";
                break;
            case 7 :
                className = "seven-of-";
                break;
            case 8 :
                className = "eight-of-";
                break;
            case 9 :
                className = "nine-of-";
                break;
            case 10 :
                className = "ten-of-";
                break;
            case 11 :
                className = "jack-of-";
                break;
            case 12 :
                className = "queen-of-";
                break;
            case 13 :
                className = "king-of-";
                break;
        }
        className += suit.toLowerCase();

        return "<div class='card " + className + "' data-value='" + rank +"'></div>";
    }

    function getRanking(){
                $.ajax({
                type: 'GET',
                url: '/api/black-jack/ranking',
                contentType:'application/json;'
            }).done(function(data){

                $("#ranking").html('');

                for(var i=0; i<data.length; i++){
                    $("#ranking").html( $("#ranking").html() + data[i].name + " " +data[i].account + "<br>");
                }
                console.log(data);

            });
    }
</script>

</html>